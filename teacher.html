<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Nexus - æ•™å¸«ä¸­æ§å° (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sidebar-bg: #1a1a1a; --main-bg: #f4f6f8; --accent: #007bff; --success: #28a745; --danger: #dc3545; --text-dark: #333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--main-bg); overflow: hidden; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; flex-shrink: 0; }
        .brand { font-size: 1.4em; font-weight: bold; color: #00ff9d; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; cursor: pointer; color: #bbb; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: #333; color: white; }
        .menu-item.active { background: #007bff33; color: #007bff; border-left: 4px solid var(--accent); }

        /* ä¸»å…§å®¹ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { margin: 0; color: var(--text-dark); font-size: 1.8em; }

        /* è¦–åœ–åˆ‡æ› */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å„€è¡¨æ¿å¡ç‰‡ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .stat-card h3 { margin: 0; color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--text-dark); margin-top: 10px; }
        .stat-card .desc { font-size: 0.85em; color: #aaa; margin-top: 5px; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.85em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9f9f9; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-draft { background: #f8d7da; color: #721c24; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9em; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-danger { background: #fff; border: 1px solid #e0e0e0; color: var(--danger); }
        .btn-danger:hover { background: #fff5f5; border-color: var(--danger); }
        .btn-icon { padding: 5px; background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.6; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal { background: white; width: 550px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; font-size: 0.9em; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1em; transition: 0.2s; }
        .form-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        textarea.form-input { height: 100px; font-family: monospace; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">ğŸš€ Code Nexus Pro</div>
        <div class="menu-item active" onclick="app.switchView('dashboard')">ğŸ“Š æ•¸æ“šå„€è¡¨æ¿</div>
        <div class="menu-item" onclick="app.switchView('courses')">ğŸ“š èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="app.switchView('students')">ğŸ“ å­¸ç”Ÿåå–®</div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333;">
            <div style="font-size: 0.8em; color: #666;">ç³»çµ±ç‹€æ…‹: <span style="color:#00ff9d">é€£ç·šæ­£å¸¸</span></div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="view-dashboard" class="view-section active">
            <div class="header">
                <h2>å¹³å°æ¦‚æ³</h2>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>ç¸½èª²ç¨‹å–®å…ƒ</h3>
                    <div class="number" id="stat-total-units">0</div>
                    <div class="desc">å·²å»ºç«‹çš„æ•™ææ•¸é‡</div>
                </div>
                <div class="stat-card">
                    <h3>ä¸Šæ¶ä¸­èª²ç¨‹</h3>
                    <div class="number" id="stat-active-units" style="color: #00b894;">0</div>
                    <div class="desc">å­¸ç”Ÿç›®å‰å¯è¦‹çš„èª²ç¨‹</div>
                </div>
                <div class="stat-card">
                    <h3>è¨»å†Šå­¸ç”Ÿ</h3>
                    <div class="number" id="stat-total-students" style="color: #007bff;">0</div>
                    <div class="desc">è³‡æ–™åº«ä¸­çš„å­¸ç”Ÿç´€éŒ„</div>
                </div>
            </div>
            
            <div class="table-container" style="padding: 20px;">
                <h4 style="margin-top:0;">å–®å…ƒç‹€æ…‹åˆ†ä½ˆ</h4>
                <div style="height: 300px;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <div id="view-courses" class="view-section">
            <div class="header">
                <h2>æ•™æåˆ—è¡¨</h2>
                <button class="btn btn-primary" onclick="app.openModal()">+ æ–°å¢å–®å…ƒ</button>
            </div>
            <div class="table-container">
                <table class="course-table">
                    <thead>
                        <tr>
                            <th width="60">æ’åº</th>
                            <th>å–®å…ƒæ¨™é¡Œ</th>
                            <th>YouTube ID</th>
                            <th>ç‹€æ…‹</th>
                            <th width="150">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="course-list-body">
                        <tr><td colspan="5" style="text-align:center; color:#888;">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-students" class="view-section">
            <div class="header"><h2>å­¸ç”Ÿåå–®</h2></div>
            <div class="table-container">
                <table class="student-table">
                    <thead>
                        <tr>
                            <th>å­¸è™Ÿ</th>
                            <th>å§“å (Demo)</th>
                            <th>åŠ å…¥æ™‚é–“</th>
                            <th>é€²åº¦</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body">
                        <tr><td colspan="4" style="text-align:center; padding: 30px; color:#888;">å°šç„¡å­¸ç”Ÿè³‡æ–™ (è«‹å…ˆå¯¦ä½œå­¸ç”Ÿç™»å…¥)</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="modal-form" class="modal-overlay">
        <div class="modal">
            <h2 id="modal-title" style="margin-top:0;">æ–°å¢æ•™æ</h2>
            <input type="hidden" id="inp-id">
            
            <div style="display:flex; gap:15px;">
                <div class="form-group" style="flex:1;">
                    <label>æ’åº (Order)</label>
                    <input type="number" id="inp-order" class="form-input" value="1">
                </div>
                <div class="form-group" style="flex:2;">
                    <label>YouTube ID</label>
                    <input type="text" id="inp-vid" class="form-input" placeholder="ä¾‹å¦‚ï¼šPqFKRqpHrjw">
                </div>
            </div>

            <div class="form-group">
                <label>å–®å…ƒæ¨™é¡Œ</label>
                <input type="text" id="inp-title" class="form-input" placeholder="å–®å…ƒåç¨±">
            </div>

            <div class="form-group">
                <label>é‡é»æ‘˜è¦ (Summary)</label>
                <textarea id="inp-summary" class="form-input" placeholder="é¡¯ç¤ºåœ¨å½±ç‰‡ä¸‹æ–¹çš„æ–‡å­—..."></textarea>
            </div>

            <div class="form-group">
                <label>ç¯„ä¾‹ä»£ç¢¼ (Code)</label>
                <textarea id="inp-code" class="form-input" style="font-family: monospace; background:#f8f9fa;" placeholder="Python ç¯„ä¾‹ä»£ç¢¼..."></textarea>
            </div>

            <div class="form-group">
                <label>ç™¼å¸ƒç‹€æ…‹</label>
                <select id="inp-active" class="form-input">
                    <option value="true">ğŸŸ¢ ç«‹å³ä¸Šæ¶</option>
                    <option value="false">ğŸ”´ å­˜ç‚ºè‰ç¨¿</option>
                </select>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                <button class="btn" style="background:#eee;" onclick="app.closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="app.saveData()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ====================================================
        // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase Config â˜…â˜…â˜…
        // ====================================================
        const firebaseConfig = {
              apiKey: "AIzaSyBgx03WUCJhe3ymWhecEYfiyShmcy9bCkg",
              authDomain: "code-a1ef3.firebaseapp.com",
              projectId: "code-a1ef3",
              storageBucket: "code-a1ef3.firebasestorage.app",
              messagingSenderId: "733626558270",
              appId: "1:733626558270:web:6d0ffcae5a5b329b212e6f",
              measurementId: "G-547WFQWRHZ"
        };

        // æ‡‰ç”¨ç¨‹å¼å‘½åç©ºé–“ (é¿å…å…¨åŸŸæ±™æŸ“)
        window.app = {};

        // åˆå§‹åŒ–
        let db;
        
        try {
            if (firebaseConfig.projectId.includes("YOUR_PROJECT")) {
                throw new Error("è«‹å…ˆä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ firebaseConfigï¼");
            }
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            console.log("Firebase é€£ç·šæˆåŠŸ");
            initRealtimeListeners(); // å•Ÿå‹•ç›£è½
        } catch (e) {
            alert("ç³»çµ±éŒ¯èª¤: " + e.message);
            console.error(e);
        }

        // === å³æ™‚ç›£è½èˆ‡è³‡æ–™è™•ç† ===
        function initRealtimeListeners() {
            // ç›£è½ units é›†åˆ (è‡ªå‹•æ›´æ–°åˆ—è¡¨èˆ‡å„€è¡¨æ¿)
            const q = query(collection(db, "units"), orderBy("order", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const units = [];
                let activeCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    units.push({ id: doc.id, ...data });
                    if (data.isActive) activeCount++;
                });

                renderCourseTable(units);
                updateDashboard(units.length, activeCount);
            });

            // ç›£è½ students é›†åˆ (è‹¥æœ‰)
            onSnapshot(collection(db, "students"), (snapshot) => {
                document.getElementById('stat-total-students').innerText = snapshot.size;
                // é€™è£¡å¯ä»¥å‘¼å« renderStudentTable(snapshot)
            });
        }

        // æ¸²æŸ“èª²ç¨‹è¡¨æ ¼
        function renderCourseTable(units) {
            const tbody = document.getElementById('course-list-body');
            tbody.innerHTML = "";

            if(units.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">ç›®å‰æ²’æœ‰èª²ç¨‹ï¼Œè«‹æŒ‰å³ä¸Šè§’æ–°å¢</td></tr>`;
                return;
            }

            units.forEach(unit => {
                const badge = unit.isActive 
                    ? `<span class="badge badge-active">ä¸Šæ¶ä¸­</span>` 
                    : `<span class="badge badge-draft">è‰ç¨¿</span>`;
                
                // æŠŠç‰©ä»¶è½‰å­—ä¸²ï¼Œæ–¹ä¾¿å‚³éçµ¦ç·¨è¼¯å‡½å¼
                const dataStr = encodeURIComponent(JSON.stringify(unit));

                const row = `
                    <tr>
                        <td><strong>${unit.order}</strong></td>
                        <td>${unit.title}</td>
                        <td><code style="background:#eee; padding:2px 5px; border-radius:4px;">${unit.youtubeId}</code></td>
                        <td>${badge}</td>
                        <td>
                            <button class="btn-icon" title="ç·¨è¼¯" onclick="app.editCourse('${dataStr}')">âœï¸</button>
                            <button class="btn-icon" title="åˆ‡æ›ç‹€æ…‹" onclick="app.toggleStatus('${unit.id}', ${unit.isActive})">ğŸ”„</button>
                            <button class="btn-icon" title="åˆªé™¤" style="color:red;" onclick="app.deleteCourse('${unit.id}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // æ›´æ–°å„€è¡¨æ¿æ•¸æ“šèˆ‡åœ–è¡¨
        let chartInstance = null;
        function updateDashboard(total, active) {
            document.getElementById('stat-total-units').innerText = total;
            document.getElementById('stat-active-units').innerText = active;

            // æ›´æ–°åœ–è¡¨
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²ä¸Šæ¶', 'è‰ç¨¿ä¸­'],
                    datasets: [{
                        data: [active, total - active],
                        backgroundColor: ['#00b894', '#ff7675'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        // === å‹•ä½œå‡½å¼ (æ›è¼‰åˆ° window.app) ===

        window.app.switchView = function(viewName) {
            // åˆ‡æ›é¸å–® Active
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            // æ‰¾å‡ºé»æ“Šçš„é‚£å€‹æŒ‰éˆ• (é€é event target æœ‰é»éº»ç…©ï¼Œé€™è£¡ç°¡å–®åš)
            const buttons = document.querySelectorAll('.menu-item');
            if(viewName === 'dashboard') buttons[0].classList.add('active');
            if(viewName === 'courses') buttons[1].classList.add('active');
            if(viewName === 'students') buttons[2].classList.add('active');

            // åˆ‡æ›è¦–åœ–
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
        }

        window.app.openModal = function() {
            document.getElementById('modal-title').innerText = "æ–°å¢æ•™æå–®å…ƒ";
            document.getElementById('inp-id').value = "";
            document.getElementById('inp-order').value = document.getElementById('course-list-body').rows.length + 1; // è‡ªå‹•è·³è™Ÿ
            document.getElementById('inp-title').value = "";
            document.getElementById('inp-vid').value = "";
            document.getElementById('inp-summary').value = "";
            document.getElementById('inp-code').value = "";
            document.getElementById('inp-active').value = "true";
            document.getElementById('modal-form').style.display = "flex";
        }

        window.app.closeModal = function() {
            document.getElementById('modal-form').style.display = "none";
        }

        window.app.editCourse = function(dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            document.getElementById('modal-title').innerText = "ç·¨è¼¯æ•™æ";
            document.getElementById('inp-id').value = data.id;
            document.getElementById('inp-order').value = data.order;
            document.getElementById('inp-title').value = data.title;
            document.getElementById('inp-vid').value = data.youtubeId;
            document.getElementById('inp-summary').value = data.summary;
            document.getElementById('inp-code').value = data.code;
            document.getElementById('inp-active').value = data.isActive ? "true" : "false";
            document.getElementById('modal-form').style.display = "flex";
        }

        window.app.saveData = async function() {
            const id = document.getElementById('inp-id').value;
            const payload = {
                order: Number(document.getElementById('inp-order').value),
                title: document.getElementById('inp-title').value,
                youtubeId: document.getElementById('inp-vid').value,
                summary: document.getElementById('inp-summary').value,
                code: document.getElementById('inp-code').value,
                isActive: document.getElementById('inp-active').value === 'true',
                updatedAt: new Date()
            };

            if(!payload.title || !payload.youtubeId) return alert("è«‹å¡«å¯«æ¨™é¡Œå’Œå½±ç‰‡ID");

            try {
                if (id) {
                    await updateDoc(doc(db, "units", id), payload);
                } else {
                    payload.createdAt = new Date();
                    await addDoc(collection(db, "units"), payload);
                }
                window.app.closeModal();
                // é€™è£¡ä¸ç”¨æ‰‹å‹• reloadï¼Œå› ç‚ºæœ‰ onSnapshot ç›£è½
            } catch (e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
            }
        }

        window.app.deleteCourse = async function(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
            try {
                await deleteDoc(doc(db, "units", id));
            } catch (e) {
                alert("åˆªé™¤å¤±æ•—");
            }
        }

        window.app.toggleStatus = async function(id, currentStatus) {
            try {
                await updateDoc(doc(db, "units", id), {
                    isActive: !currentStatus
                });
            } catch (e) {
                alert("æ›´æ–°ç‹€æ…‹å¤±æ•—");
            }
        }

    </script>
</body>
</html>
