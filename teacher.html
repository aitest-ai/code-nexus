<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Nexus - æ•™å¸«æ——è‰¦å¾Œå° (V5.0)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sidebar-bg: #1a1a1a; --main-bg: #f4f6f8; --accent: #007bff; --text-dark: #333; --card-bg: #fff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--main-bg); overflow: hidden; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; flex-shrink: 0; }
        .brand { font-size: 1.4em; font-weight: bold; color: #00ff9d; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; cursor: pointer; color: #bbb; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: #333; color: white; }
        .menu-item.active { background: #007bff33; color: #007bff; border-left: 4px solid var(--accent); }

        /* ä¸»å…§å®¹ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { margin: 0; color: var(--text-dark); font-size: 1.8em; }

        /* è¦–åœ–åˆ‡æ› */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å„€è¡¨æ¿èˆ‡å¡ç‰‡ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-card h3 { margin: 0; color: #888; font-size: 0.9rem; text-transform: uppercase; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--text-dark); margin-top: 10px; }

        /* è¡¨æ ¼ */
        .table-container { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; color: #555; font-size: 0.85em; text-transform: uppercase; }
        tr:hover { background-color: #f9f9f9; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75em; font-weight: bold; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-draft { background: #f8d7da; color: #721c24; }
        .badge-phase { background: #e2e3e5; color: #383d41; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #333; }
        .btn-icon { padding: 5px; background: transparent; border: none; font-size: 1.2em; cursor: pointer; }

        /* === å­¸ç”Ÿè©³æƒ… Modal (LMS é‡é») === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-large { background: #f4f6f8; width: 90%; max-width: 1000px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { background: white; padding: 20px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; padding: 30px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* è©³æƒ…å¡ç‰‡ */
        .detail-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); break-inside: avoid; margin-bottom: 20px; }
        .detail-card h4 { margin-top: 0; color: var(--accent); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .code-block { background: #2d2d2d; color: #ccc; padding: 15px; border-radius: 6px; font-family: monospace; overflow-x: auto; font-size: 0.9em; margin-top: 10px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .info-label { color: #888; }
        .info-val { font-weight: bold; color: #333; }
        .ai-comment { background: #fffbe6; padding: 10px; border-radius: 6px; border-left: 4px solid #ffe58f; font-size: 0.9em; color: #666; margin-top: 10px; line-height: 1.5; }

        /* ä¸€èˆ¬ Modal (ç·¨è¼¯ç”¨) */
        .modal-small { background: white; width: 500px; padding: 30px; border-radius: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">ğŸš€ Code Nexus Pro</div>
        <div class="menu-item active" onclick="app.switchView('dashboard')">ğŸ“Š æ•¸æ“šå„€è¡¨æ¿</div>
        <div class="menu-item" onclick="app.switchView('courses')">ğŸ“š èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="app.switchView('students')">ğŸ“ å­¸ç”Ÿåå–®</div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333; font-size: 0.8em; color: #666;">Status: Online</div>
    </div>

    <div class="main-content">
        
        <div id="view-dashboard" class="view-section active">
            <div class="header"><h2>å¹³å°æ¦‚æ³</h2></div>
            <div class="dashboard-grid">
                <div class="stat-card"><h3>ç¸½èª²ç¨‹å–®å…ƒ</h3><div class="number" id="stat-units">0</div></div>
                <div class="stat-card"><h3>ä¸Šæ¶ä¸­</h3><div class="number" id="stat-active" style="color:#00b894">0</div></div>
                <div class="stat-card"><h3>æ´»èºå­¸ç”Ÿ</h3><div class="number" id="stat-students" style="color:#007bff">0</div></div>
            </div>
            <div class="table-container" style="padding:20px;">
                <h4>å–®å…ƒç‹€æ…‹åˆ†ä½ˆ</h4><div style="height:300px;"><canvas id="mainChart"></canvas></div>
            </div>
        </div>

        <div id="view-courses" class="view-section">
            <div class="header"><h2>æ•™æåˆ—è¡¨</h2><button class="btn btn-primary" onclick="app.openCourseModal()">+ æ–°å¢å–®å…ƒ</button></div>
            <div class="table-container">
                <table class="course-table">
                    <thead><tr><th>æ’åº</th><th>æ¨™é¡Œ</th><th>å½±ç‰‡ID</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="course-list-body"><tr><td colspan="5" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="view-students" class="view-section">
            <div class="header"><h2>å­¸ç”Ÿå­¸ç¿’ç‹€æ³</h2></div>
            <div class="table-container">
                <table class="student-table">
                    <thead><tr><th>å­¸è™Ÿ</th><th>æœ€å¾Œæ´»å‹•æ™‚é–“</th><th>ç•¶å‰é€²åº¦</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="student-list-body"><tr><td colspan="4" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-student-detail" class="modal-overlay">
        <div class="modal-large">
            <div class="modal-header">
                <h2 style="margin:0;">ğŸ“„ å­¸ç¿’æ­·ç¨‹æª”æ¡ˆï¼š<span id="detail-student-id" style="color:var(--accent);">--</span></h2>
                <button class="btn btn-outline" onclick="app.closeDetailModal()">âŒ é—œé–‰</button>
            </div>
            <div class="modal-body" id="detail-body">
                </div>
        </div>
    </div>

    <div id="modal-course-form" class="modal-overlay">
        <div class="modal-small">
            <h3 id="modal-course-title">æ–°å¢æ•™æ</h3>
            <input type="hidden" id="inp-id">
            <div class="form-group"><label>æ’åº</label><input type="number" id="inp-order" class="form-input" value="1"></div>
            <div class="form-group"><label>æ¨™é¡Œ</label><input type="text" id="inp-title" class="form-input"></div>
            <div class="form-group"><label>å½±ç‰‡ID</label><input type="text" id="inp-vid" class="form-input"></div>
            <div class="form-group"><label>æ‘˜è¦</label><input type="text" id="inp-summary" class="form-input"></div>
            <div class="form-group"><label>ä»£ç¢¼</label><textarea id="inp-code" class="form-input" style="height:80px;"></textarea></div>
            <div class="form-group"><label>ç‹€æ…‹</label><select id="inp-active" class="form-input"><option value="true">ä¸Šæ¶</option><option value="false">è‰ç¨¿</option></select></div>
            <div style="text-align:right;"><button class="btn" onclick="app.closeCourseModal()">å–æ¶ˆ</button> <button class="btn btn-primary" onclick="app.saveCourse()">å„²å­˜</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // â˜…â˜…â˜… è«‹å¡«å…¥æ‚¨çš„ Firebase Config â˜…â˜…â˜…
        // ==========================================
        const firebaseConfig = {
              apiKey: "AIzaSyBgx03WUCJhe3ymWhecEYfiyShmcy9bCkg",
              authDomain: "code-a1ef3.firebaseapp.com",
              projectId: "code-a1ef3",
              storageBucket: "code-a1ef3.firebasestorage.app",
              messagingSenderId: "733626558270",
              appId: "1:733626558270:web:6d0ffcae5a5b329b212e6f",
              measurementId: "G-547WFQWRHZ"
        };

        window.app = {};
        let db;
        let chartInstance = null;

        try {
            if (firebaseConfig.projectId.includes("YOUR_PROJECT")) throw new Error("è«‹å¡«å…¥ Config");
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            initListeners();
        } catch (e) { alert("Config éŒ¯èª¤: " + e.message); }

        function initListeners() {
            // èª²ç¨‹ç›£è½
            onSnapshot(query(collection(db, "units"), orderBy("order", "asc")), snap => {
                const units = [];
                let activeCount = 0;
                snap.forEach(d => { const data=d.data(); units.push({id:d.id, ...data}); if(data.isActive) activeCount++; });
                renderCourses(units);
                updateDash(units.length, activeCount);
            });

            // å­¸ç”Ÿç´€éŒ„ç›£è½ (é€™è£¡åªåšåˆ—è¡¨ï¼Œè©³æƒ…å¦å¤–æŠ“)
            onSnapshot(collection(db, "records"), snap => {
                const students = {};
                snap.forEach(d => {
                    const data = d.data();
                    if(!data.studentId) return;
                    if(!students[data.studentId] || data.createdAt > students[data.studentId].createdAt) {
                        students[data.studentId] = { id: data.studentId, lastAction: data.type, time: data.createdAt };
                    }
                });
                renderStudents(Object.values(students));
                document.getElementById('stat-students').innerText = Object.keys(students).length;
            });
        }

        // === æ¸²æŸ“é‚è¼¯ ===
        function renderCourses(list) {
            const el = document.getElementById('course-list-body');
            el.innerHTML = list.map(u => `
                <tr>
                    <td>${u.order}</td><td>${u.title}</td><td>${u.youtubeId}</td>
                    <td>${u.isActive?'<span class="badge badge-active">ä¸Šæ¶</span>':'<span class="badge badge-draft">è‰ç¨¿</span>'}</td>
                    <td>
                        <button class="btn-icon" onclick="app.editCourse('${encodeURIComponent(JSON.stringify(u))}')">âœï¸</button>
                        <button class="btn-icon" onclick="app.toggleStatus('${u.id}',${u.isActive})">ğŸ”„</button>
                        <button class="btn-icon" style="color:red;" onclick="app.delCourse('${u.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`).join('');
        }

        function renderStudents(list) {
            const el = document.getElementById('student-list-body');
            // æ™‚é–“æ’åº (æ–°åˆ°èˆŠ)
            list.sort((a,b) => b.time - a.time);
            
            el.innerHTML = list.map(s => {
                const t = s.time && s.time.seconds ? new Date(s.time.seconds*1000).toLocaleString() : 'å‰›å‰›';
                return `
                <tr>
                    <td><strong>${s.id}</strong></td>
                    <td style="color:#666;">${t}</td>
                    <td><span class="badge badge-phase">${s.lastAction}</span></td>
                    <td><button class="btn btn-primary" onclick="app.viewDetail('${s.id}')">ğŸ“„ æŸ¥çœ‹å ±å‘Š</button></td>
                </tr>`;
            }).join('');
        }

        function updateDash(total, active) {
            document.getElementById('stat-units').innerText = total;
            document.getElementById('stat-active').innerText = active;
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['ä¸Šæ¶', 'è‰ç¨¿'], datasets: [{ data: [active, total-active], backgroundColor: ['#00b894', '#ff7675'] }] } });
        }

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šæŸ¥çœ‹å­¸ç”Ÿè©³æƒ… (Portfolio) ===
        window.app.viewDetail = async function(sid) {
            document.getElementById('detail-student-id').innerText = sid;
            const body = document.getElementById('detail-body');
            body.innerHTML = '<div style="grid-column:span 2; text-align:center;">è¼‰å…¥è©³ç´°è³‡æ–™ä¸­...</div>';
            document.getElementById('modal-student-detail').style.display = 'flex';

            // æŸ¥è©¢è©²å­¸ç”Ÿçš„æ‰€æœ‰ç´€éŒ„ï¼ŒæŒ‰æ™‚é–“æ’åº
            const q = query(collection(db, "records"), where("studentId", "==", sid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            
            // è³‡æ–™åˆ†é¡
            const data = {
                learning: null,
                exercise: [], // ç·´ç¿’å¯èƒ½æœ‰å¤šç­†
                posing: null,
                aiReview: null,
                peerReview: [],
                reflection: null
            };

            snap.forEach(d => {
                const r = d.data();
                if(r.type === 'PHASE_1_LEARNING' && !data.learning) data.learning = r;
                if(r.type === 'PHASE_2_EXERCISE') data.exercise.push(r);
                if(r.type === 'PHASE_3_POSING' && !data.posing) data.posing = r;
                if(r.type === 'PHASE_4_AI' && !data.aiReview) data.aiReview = r;
                if(r.type === 'PHASE_5_PEER') data.peerReview.push(r);
                if(r.type === 'PHASE_6_REFLECTION' && !data.reflection) data.reflection = r;
            });

            // ç”¢ç”Ÿ HTML
            let html = "";

            // 1. å­¸ç¿’å¡
            html += `
            <div class="detail-card">
                <h4>ğŸ¥ å­¸ç¿’éšæ®µ (Learning)</h4>
                ${data.learning ? `
                    <div class="info-row"><span class="info-label">é–±è®€æ™‚é•·</span><span class="info-val">${data.learning.readingTime} ç§’</span></div>
                    <div class="info-row"><span class="info-label">å®Œæˆæ™‚é–“</span><span class="info-val">${new Date(data.learning.createdAt.seconds*1000).toLocaleString()}</span></div>
                ` : '<p style="color:#aaa;">ç„¡è³‡æ–™</p>'}
            </div>`;

            // 2. ç·´ç¿’å¡ (é¡¯ç¤ºæœ€æ–°ä¸€ç­†)
            const ex = data.exercise[0];
            html += `
            <div class="detail-card">
                <h4>ğŸ‹ï¸ ç·´ç¿’éšæ®µ (Exercise)</h4>
                ${ex ? `
                    <div class="info-row"><span class="info-label">é›£åº¦</span><span class="info-val badge badge-active">${ex.difficulty}</span></div>
                    <div class="info-row"><span class="info-label">çµæœ</span><span class="info-val">${ex.passed}</span></div>
                    <div class="info-label">å­¸ç”Ÿä»£ç¢¼ï¼š</div>
                    <div class="code-block">${escapeHtml(ex.code)}</div>
                    <div class="ai-comment"><strong>AI å›é¥‹ï¼š</strong>${ex.feedback}</div>
                ` : '<p style="color:#aaa;">å°šæœªé€²è¡Œç·´ç¿’</p>'}
            </div>`;

            // 3. æ“¬é¡Œå¡
            const pos = data.posing;
            html += `
            <div class="detail-card">
                <h4>ğŸ“ æ“¬é¡Œéšæ®µ (Posing)</h4>
                ${pos ? `
                    <div class="info-row"><span class="info-label">é¡Œç›®</span><span class="info-val">${pos.probTitle}</span></div>
                    <div class="info-label">æ•˜è¿°ï¼š</div>
                    <p style="background:#f9f9f9; padding:10px; border-radius:4px;">${pos.probDesc}</p>
                    <div class="info-label">åƒè€ƒè§£ç­”ï¼š</div>
                    <div class="code-block">${escapeHtml(pos.probCode)}</div>
                ` : '<p style="color:#aaa;">å°šæœªæ“¬é¡Œ</p>'}
            </div>`;

            // 4. AI è©•åˆ†å¡
            const ai = data.aiReview;
            html += `
            <div class="detail-card">
                <h4>ğŸ¤– AI è©•é–± (AI Review)</h4>
                ${ai ? `
                    <div class="info-row"><span class="info-label">é‡å°é¡Œç›®</span><span class="info-val">${ai.probTitle}</span></div>
                    <div class="info-row"><span class="info-label">å„é …å¾—åˆ†</span><span class="info-val">${ai.aiScores}</span></div>
                    <div class="ai-comment"><strong>AI è¬›è©•ï¼š</strong>${ai.aiComment}</div>
                ` : '<p style="color:#aaa;">AI å°šæœªè©•åˆ†</p>'}
            </div>`;

            // 5. äº’è©•å¡ (åˆ—è¡¨)
            html += `
            <div class="detail-card">
                <h4>ğŸ‘€ äº’è©•ç´€éŒ„ (Peer Review)</h4>
                ${data.peerReview.length > 0 ? data.peerReview.map(p => `
                    <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <div class="info-row"><span class="info-label">è©•é–±å°è±¡</span><span class="info-val">${p.targetTitle}</span></div>
                        <div class="info-row"><span class="info-label">çµ¦åˆ†</span><span class="info-val">${p.scores}</span></div>
                        <div style="font-size:0.9em; color:#666;">è©•èªï¼š${p.comment}</div>
                    </div>
                `).join('') : '<p style="color:#aaa;">å°šç„¡äº’è©•ç´€éŒ„</p>'}
            </div>`;

            // 6. åæ€å¡
            const ref = data.reflection;
            html += `
            <div class="detail-card">
                <h4>ğŸ¤” å­¸ç¿’åæ€ (Reflection)</h4>
                ${ref ? `
                    <p style="line-height:1.6;">${ref.reflection}</p>
                    <div style="text-align:right; font-size:0.8em; color:#aaa;">${new Date(ref.createdAt.seconds*1000).toLocaleString()}</div>
                ` : '<p style="color:#aaa;">å°šæœªå¡«å¯«åæ€</p>'}
            </div>`;

            body.innerHTML = html;
        }

        function escapeHtml(text) {
            if(!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // === UI Helpers ===
        window.app.switchView = function(n) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+n).classList.add('active'); document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); }
        window.app.closeDetailModal = function() { document.getElementById('modal-student-detail').style.display='none'; }
        
        // Course CRUD
        window.app.openCourseModal = function() { document.getElementById('modal-course-form').style.display='flex'; document.getElementById('modal-course-title').innerText="æ–°å¢æ•™æ"; document.getElementById('inp-id').value=""; document.getElementById('inp-title').value=""; document.getElementById('inp-vid').value=""; document.getElementById('inp-summary').value=""; document.getElementById('inp-code').value=""; }
        window.app.closeCourseModal = function() { document.getElementById('modal-course-form').style.display='none'; }
        window.app.editCourse = function(s) { const d=JSON.parse(decodeURIComponent(s)); document.getElementById('modal-course-form').style.display='flex'; document.getElementById('modal-course-title').innerText="ç·¨è¼¯æ•™æ"; document.getElementById('inp-id').value=d.id; document.getElementById('inp-order').value=d.order; document.getElementById('inp-title').value=d.title; document.getElementById('inp-vid').value=d.youtubeId; document.getElementById('inp-summary').value=d.summary; document.getElementById('inp-code').value=d.code; document.getElementById('inp-active').value=d.isActive; }
        window.app.saveCourse = async function() {
            const id=document.getElementById('inp-id').value;
            const p={order:Number(document.getElementById('inp-order').value), title:document.getElementById('inp-title').value, youtubeId:document.getElementById('inp-vid').value, summary:document.getElementById('inp-summary').value, code:document.getElementById('inp-code').value, isActive:document.getElementById('inp-active').value==='true', updatedAt:new Date()};
            try { if(id) await updateDoc(doc(db,"units",id),p); else { p.createdAt=new Date(); await addDoc(collection(db,"units"),p); } window.app.closeCourseModal(); } catch(e){alert(e.message);}
        }
        window.app.delCourse = async function(id) { if(confirm("ç¢ºå®šåˆªé™¤?")) await deleteDoc(doc(db,"units",id)); }
        window.app.toggleStatus = async function(id,s) { await updateDoc(doc(db,"units",id),{isActive:!s}); }

    </script>
</body>
</html>
