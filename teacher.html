<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Nexus - Teacher V9.1 (All Features Intact)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* =========================================
           1. æ ¸å¿ƒæ¨£å¼èˆ‡æ’ç‰ˆ
           ========================================= */
        :root { 
            --sidebar-bg: #1a1a1a; 
            --main-bg: #f4f6f8; 
            --accent: #007bff; 
            --text-dark: #333; 
            --card-bg: #fff; 
            --border-color: #eee;
        }
        body { 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            background: var(--main-bg); 
            overflow: hidden; 
        }
        
        /* å´é‚Šæ¬„ */
        .sidebar { 
            width: 260px; 
            background: var(--sidebar-bg); 
            color: #fff; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
            flex-shrink: 0; 
        }
        .brand { 
            font-size: 1.4em; 
            font-weight: bold; 
            color: #00ff9d; 
            margin-bottom: 40px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .menu-item { 
            padding: 12px 15px; 
            cursor: pointer; 
            color: #bbb; 
            border-radius: 8px; 
            margin-bottom: 5px; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .menu-item:hover { background: #333; color: white; }
        .menu-item.active { 
            background: rgba(0, 123, 255, 0.2); 
            color: #007bff; 
            border-left: 4px solid var(--accent); 
        }

        /* ä¸»å…§å®¹å€ */
        .main-content { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
        }
        .header h2 { margin: 0; color: var(--text-dark); font-size: 1.8em; }

        /* è¦–åœ–åˆ‡æ›å‹•ç•« */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           2. å„€è¡¨æ¿èˆ‡è¡¨æ ¼çµ„ä»¶
           ========================================= */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        .stat-card h3 { 
            margin: 0; 
            color: #888; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
        }
        .stat-card .number { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: var(--text-dark); 
            margin-top: 10px; 
        }

        .table-container { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            overflow: hidden; 
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 15px 20px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        }
        th { 
            background: #fafafa; 
            font-weight: 600; 
            color: #555; 
            font-size: 0.85em; 
            text-transform: uppercase; 
        }
        tr:hover { background-color: #f9f9f9; }

        /* æ¨™ç±¤èˆ‡æŒ‰éˆ• */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75em; font-weight: bold; display: inline-block; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-draft { background: #f8d7da; color: #721c24; }
        .badge-date { background: #e2e3e5; color: #383d41; font-family: monospace; }
        .badge-unit { background: #cce5ff; color: #004085; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9em; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-outline { background: white; border: 1px solid #ddd; color: #333; }
        .btn-outline:hover { background: #f0f0f0; }
        .btn-icon { padding: 5px; background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }

        /* =========================================
           3. Modal èˆ‡ å­¸ç¿’æ­·ç¨‹ (Portfolio)
           ========================================= */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; 
            z-index: 2000; backdrop-filter: blur(3px); 
        }
        
        .modal-large { 
            background: #f4f6f8; 
            width: 95%; max-width: 1100px; height: 90vh; 
            border-radius: 12px; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
        }
        .modal-header { 
            background: white; padding: 20px 30px; 
            border-bottom: 1px solid #ddd; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        
        /* è©³æƒ…é åˆ†é å°èˆª */
        .detail-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; padding: 0 30px; }
        .detail-tab { padding: 15px 20px; cursor: pointer; color: #666; border-bottom: 3px solid transparent; transition: 0.2s; }
        .detail-tab:hover { color: var(--accent); }
        .detail-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }
        
        .modal-body { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .modal-body.active { display: block; } /* æ§åˆ¶åˆ†é é¡¯ç¤º */

        .detail-card { 
            background: white; 
            border-radius: 10px; 
            padding: 25px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            break-inside: avoid; 
            margin-bottom: 20px; 
        }
        .detail-card h4 { 
            margin-top: 0; 
            color: var(--accent); 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 10px; 
        }
        .info-row { 
            display: flex; justify-content: space-between; 
            margin-bottom: 8px; font-size: 0.9em; 
            border-bottom: 1px dashed #eee; padding-bottom: 5px; 
        }
        .code-block { 
            background: #2d2d2d; color: #ccc; 
            padding: 15px; border-radius: 6px; 
            font-family: monospace; overflow-x: auto; 
            font-size: 0.9em; margin-top: 10px; 
        }
        .chat-log-box { 
            max-height: 400px; overflow-y: auto; 
            background: #f9f9f9; padding: 15px; 
            border-radius: 6px; font-size: 0.9em; 
        }
        .chat-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .chat-user { color: #007bff; font-weight: bold; }
        .chat-ai { color: #28a745; font-weight: bold; }

        /* ä¸€èˆ¬ç·¨è¼¯ Modal (èª²ç¨‹/é¡Œç›®) */
        .modal-small { 
            background: white; width: 600px; 
            padding: 30px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-input { 
            width: 100%; padding: 10px; 
            border: 1px solid #ddd; border-radius: 4px; 
            box-sizing: border-box; 
        }
        textarea.form-input { font-family: monospace; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">ğŸš€ Code Nexus Pro</div>
        <div class="menu-item active" onclick="app.switchView('dashboard')">ğŸ“Š æ•¸æ“šå„€è¡¨æ¿</div>
        <div class="menu-item" onclick="app.switchView('courses')">ğŸ“š èª²ç¨‹èˆ‡æ’ç¨‹</div>
        <div class="menu-item" onclick="app.switchView('questions')">ğŸ§© é¡Œåº«å¯©æ ¸</div>
        <div class="menu-item" onclick="app.switchView('students')">ğŸ“ å­¸ç”Ÿåå–®</div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333; font-size: 0.8em; color: #666;">Status: <span style="color:#00ff9d">Online</span></div>
    </div>

    <div class="main-content">
        
        <div id="view-dashboard" class="view-section active">
            <div class="header"><h2>å¹³å°æ¦‚æ³</h2></div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>ç¸½èª²ç¨‹å–®å…ƒ</h3><div class="number" id="stat-units">0</div>
                </div>
                <div class="stat-card">
                    <h3>å­¸ç”Ÿå‡ºé¡Œç¸½æ•¸</h3><div class="number" id="stat-questions">0</div>
                </div>
                <div class="stat-card">
                    <h3>æ´»èºå­¸ç”Ÿæ•¸</h3><div class="number" id="stat-students" style="color:#007bff">0</div>
                </div>
            </div>
            <div class="table-container" style="padding:20px;">
                <h4>èª²ç¨‹ç‹€æ…‹åˆ†ä½ˆ</h4>
                <div style="height:300px;"><canvas id="mainChart"></canvas></div>
            </div>
        </div>

        <div id="view-courses" class="view-section">
            <div class="header">
                <h2>æ•™æåˆ—è¡¨èˆ‡æ’ç¨‹</h2>
                <button class="btn btn-primary" onclick="app.openCourseModal()">+ æ–°å¢å–®å…ƒ</button>
            </div>
            <div class="table-container">
                <table class="course-table">
                    <thead><tr><th width="50">åº</th><th>å–®å…ƒæ¨™é¡Œ</th><th>é–‹æ”¾æ—¥æœŸ</th><th>å½±ç‰‡ID</th><th>ç‹€æ…‹</th><th width="150">æ“ä½œ</th></tr></thead>
                    <tbody id="course-list-body"><tr><td colspan="6" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="view-questions" class="view-section">
            <div class="header">
                <h2>å­¸ç”Ÿé¡Œåº«å¯©æ ¸ä¸­å¿ƒ</h2>
            </div>
            <div style="background:#fff; padding:15px; margin-bottom:20px; border-radius:8px; color:#666; font-size:0.9em;">
                ğŸ’¡ èªªæ˜ï¼šæ­¤è™•æ”¶é›†æ‰€æœ‰å­¸ç”Ÿåœ¨ã€Œæ“¬é¡Œéšæ®µã€é€å‡ºçš„é¡Œç›®ã€‚è€å¸«å¯é€²è¡Œä¿®æ”¹æˆ–åˆªé™¤ã€‚æœªè¢«åˆªé™¤çš„é¡Œç›®å°‡è‡ªå‹•é€²å…¥è©²å–®å…ƒçš„åŒå„•äº’è©•æ± ã€‚
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>å–®å…ƒ</th><th>å­¸ç”Ÿ</th><th>é¡Œç›®åç¨±</th><th>AI è©•åˆ†</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="question-list-body"><tr><td colspan="5" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="view-students" class="view-section">
            <div class="header"><h2>å­¸ç”Ÿå­¸ç¿’ç‹€æ³</h2></div>
            <div class="table-container">
                <table class="student-table">
                    <thead><tr><th>å­¸è™Ÿ</th><th>æœ€å¾Œæ´»å‹•æ™‚é–“</th><th>ç•¶å‰é€²åº¦</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="student-list-body"><tr><td colspan="4" style="text-align:center;">ç­‰å¾…è³‡æ–™åŒæ­¥...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-student-detail" class="modal-overlay">
        <div class="modal-large">
            <div class="modal-header">
                <h2 style="margin:0;">ğŸ“„ å­¸ç¿’æ­·ç¨‹æª”æ¡ˆï¼š<span id="detail-student-id" style="color:var(--accent);">--</span></h2>
                <button class="btn btn-outline" onclick="app.closeDetailModal()">âŒ é—œé–‰</button>
            </div>
            
            <div class="detail-tabs">
                <div class="detail-tab active" onclick="app.switchDetailTab('overview')">ğŸ“Š ç¸½è¦½åœ–è¡¨</div>
                <div class="detail-tab" onclick="app.switchDetailTab('learning')">ğŸ¥ å­¸ç¿’èˆ‡ç·´ç¿’</div>
                <div class="detail-tab" onclick="app.switchDetailTab('posing')">ğŸ“ æ“¬é¡Œèˆ‡äº’è©•</div>
                <div class="detail-tab" onclick="app.switchDetailTab('reflection')">ğŸ¤” åæ€å¿ƒå¾—</div>
                <div class="detail-tab" onclick="app.switchDetailTab('chat')">ğŸ’¬ AI å°è©±</div>
            </div>
            
            <div id="tab-overview" class="modal-body active">
                <div class="detail-card">
                    <h4>ğŸ“ˆ å£“åŠ›æŒ‡æ•¸è¶¨å‹¢ (å„ªåŒ–é¡¯ç¤ºï¼š0-50 æ”¾å¤§è‡³ 100%)</h4>
                    <p style="color:#666; font-size:0.9em; margin-bottom:15px;">èªªæ˜ï¼šç‚ºäº†æ›´æ¸…æ™°é¡¯ç¤ºæ³¢å‹•ï¼Œåœ–è¡¨å°‡åŸå§‹æ•¸å€¼ 0-50 æ”¾å¤§ç‚º 0-100% å‘ˆç¾ã€‚èƒŒæ™¯è‰²ä»£è¡¨å£“åŠ›å€é–“ (ç¶ =ä½å£“, é»ƒ=ä¸­å£“, ç´…=é«˜å£“)ã€‚</p>
                    <div style="height: 350px; width: 100%;"><canvas id="emotionChart"></canvas></div>
                </div>
            </div>

            <div id="tab-learning" class="modal-body"></div>

            <div id="tab-posing" class="modal-body"></div>

            <div id="tab-reflection" class="modal-body"></div>

            <div id="tab-chat" class="modal-body"></div>
        </div>
    </div>

    <div id="modal-form" class="modal-overlay">
        <div class="modal-small">
            <h3 id="form-title">ç·¨è¼¯</h3>
            <input type="hidden" id="inp-id">
            <input type="hidden" id="inp-type"> <div id="form-fields">
                </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button class="btn" style="background:#eee;" onclick="document.getElementById('modal-form').style.display='none'">å–æ¶ˆ</button> 
                <button class="btn btn-primary" onclick="app.saveForm()">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase Config â˜…â˜…â˜…
        // ==========================================
        const firebaseConfig = {
              apiKey: "AIzaSyBgx03WUCJhe3ymWhecEYfiyShmcy9bCkg",
              authDomain: "code-a1ef3.firebaseapp.com",
              projectId: "code-a1ef3",
              storageBucket: "code-a1ef3.firebasestorage.app",
              messagingSenderId: "733626558270",
              appId: "1:733626558270:web:6d0ffcae5a5b329b212e6f",
              measurementId: "G-547WFQWRHZ"
        };

        window.app = {};
        let db;
        let chartInstance = null;
        let emotionChartInstance = null;
        let currentDetailData = null; // æš«å­˜ç›®å‰æŸ¥çœ‹çš„å­¸ç”Ÿè³‡æ–™

        try {
            if (firebaseConfig.projectId.includes("YOUR_PROJECT")) throw new Error("è«‹å…ˆå¡«å…¥ Firebase Configï¼");
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            initListeners();
        } catch (e) { alert("ç³»çµ±éŒ¯èª¤: " + e.message); }

        function initListeners() {
            // 1. èª²ç¨‹ç›£è½
            onSnapshot(query(collection(db, "units"), orderBy("order", "asc")), snap => {
                const units = []; let activeCount = 0;
                snap.forEach(d => { const data=d.data(); units.push({id:d.id, ...data}); if(data.isActive) activeCount++; });
                renderCourses(units); updateDash(units.length, activeCount);
            });

            // 2. å­¸ç”Ÿèˆ‡é¡Œåº«ç›£è½ (ç›£è½ records é›†åˆ)
            onSnapshot(collection(db, "records"), snap => {
                const students = {};
                const questions = [];
                
                snap.forEach(d => {
                    const data = d.data();
                    const r = { id: d.id, ...data };
                    
                    // å½™æ•´å­¸ç”Ÿç‹€æ…‹ (å–æœ€æ–°ä¸€ç­†æ´»å‹•)
                    if(data.studentId) {
                        if(!students[data.studentId] || data.createdAt > students[data.studentId].createdAt) {
                            students[data.studentId] = { id: data.studentId, lastAction: data.type, time: data.createdAt };
                        }
                    }
                    
                    // å½™æ•´é¡Œåº« (ç¯©é¸ Phase 3 çš„è³‡æ–™)
                    if(data.type === 'PHASE_3_POSING') {
                        questions.push(r);
                    }
                });
                
                renderStudents(Object.values(students));
                renderQuestions(questions);
                document.getElementById('stat-students').innerText = Object.keys(students).length;
                document.getElementById('stat-questions').innerText = questions.length;
            });
        }

        // === Render Functions ===
        function renderCourses(list) {
            document.getElementById('course-list-body').innerHTML = list.map(u => `
                <tr>
                    <td>${u.order}</td>
                    <td><strong>${u.title}</strong></td>
                    <td><span class="badge badge-date">${u.releaseDate || 'æœªè¨­å®š'}</span></td>
                    <td>${u.youtubeId}</td>
                    <td>${u.isActive?'<span class="badge badge-active">ä¸Šæ¶</span>':'<span class="badge badge-draft">è‰ç¨¿</span>'}</td>
                    <td>
                        <button class="btn-icon" onclick="app.openForm('course', '${encodeURIComponent(JSON.stringify(u))}')">âœï¸</button>
                        <button class="btn-icon" onclick="app.toggleStatus('${u.id}',${u.isActive})">ğŸ”„</button>
                        <button class="btn-icon" style="color:red;" onclick="app.delDoc('units','${u.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`).join('');
        }

        function renderStudents(list) {
            list.sort((a,b) => b.time - a.time);
            const actionMap = {
                'PHASE_1_LEARNING': 'ğŸ¥ è§€çœ‹å½±ç‰‡', 'PHASE_2_EXERCISE': 'ğŸ‹ï¸ ç·´ç¿’é¡Œ', 'PHASE_3_POSING': 'ğŸ“ å‡ºé¡Œä¸­',
                'PHASE_4_AI': 'ğŸ¤– AI è©•åˆ†', 'PHASE_5_PEER': 'ğŸ‘€ åŒå„•äº’è©•', 'PHASE_6_REFLECTION': 'ğŸ¤” åæ€',
                'CHAT_LOG': 'ğŸ’¬ AI å°è©±', 'MONITOR_LOG': 'ğŸ§  å­¸ç¿’ä¸­'
            };
            document.getElementById('student-list-body').innerHTML = list.map(s => {
                const t = s.time && s.time.seconds ? new Date(s.time.seconds*1000).toLocaleTimeString() : 'å‰›å‰›';
                return `<tr><td><strong>${s.id}</strong></td><td style="color:#666;">${t}</td><td><span class="badge badge-date">${actionMap[s.lastAction] || s.lastAction}</span></td><td><button class="btn btn-primary" onclick="app.viewDetail('${s.id}')">ğŸ“„ å ±å‘Š</button></td></tr>`;
            }).join('');
        }

        function renderQuestions(list) {
            document.getElementById('question-list-body').innerHTML = list.map(q => {
                const unitName = q.unitTitle || "æœªåˆ†é¡"; 
                // è¨ˆç®—å¹³å‡åˆ† (è‹¥æœ‰)
                const scoreAvg = q.aiScores ? (q.aiScores.reduce((a,b)=>Number(a)+Number(b),0)/5).toFixed(1) : '-';
                return `<tr>
                    <td><span class="badge badge-unit">${unitName}</span></td>
                    <td>${q.studentId}</td>
                    <td><b>${q.probTitle}</b></td>
                    <td>â­ ${scoreAvg}</td>
                    <td>
                        <button class="btn-icon" onclick="app.openForm('question', '${encodeURIComponent(JSON.stringify(q))}')">âœï¸</button>
                        <button class="btn-icon" style="color:red;" onclick="app.delDoc('records','${q.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function updateDash(total, active) {
            document.getElementById('stat-units').innerText = total; document.getElementById('stat-active').innerText = active;
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['ä¸Šæ¶', 'è‰ç¨¿'], datasets: [{ data: [active, total-active], backgroundColor: ['#00b894', '#ff7675'], borderWidth:0 }] }, options:{ maintainAspectRatio:false } });
        }

        // === å­¸ç”Ÿè©³æƒ… (Tabbed Portfolio) ===
        window.app.viewDetail = async function(sid) {
            document.getElementById('detail-student-id').innerText = sid;
            document.getElementById('modal-student-detail').style.display = 'flex';
            
            // é‡ç½® Tab
            document.querySelectorAll('.detail-tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.modal-body').forEach(b=>b.classList.remove('active'));
            document.querySelector('.detail-tab:first-child').classList.add('active');
            document.getElementById('tab-overview').classList.add('active');

            // æŠ“å–è³‡æ–™
            const q = query(collection(db, "records"), where("studentId", "==", sid), orderBy("createdAt", "asc"));
            const snap = await getDocs(q);
            
            const data = { learning: null, exercise: [], posing: null, aiReview: null, peerReviews: [], reflection: null, chats: [], monitors: [] };

            snap.forEach(d => {
                const r = d.data();
                if(r.type === 'PHASE_1_LEARNING') { if (!data.learning || r.readingTime > data.learning.readingTime) data.learning = r; }
                if(r.type === 'PHASE_2_EXERCISE') data.exercise.push(r);
                if(r.type === 'PHASE_3_POSING') data.posing = r;
                if(r.type === 'PHASE_4_AI') data.aiReview = r;
                if(r.type === 'PHASE_5_PEER') data.peerReviews.push(r);
                if(r.type === 'PHASE_6_REFLECTION') data.reflection = r;
                if(r.type === 'CHAT_LOG') data.chats.push(r);
                if(r.type === 'MONITOR_LOG') data.monitors.push(r);
            });
            
            currentDetailData = data; 
            renderDetailCharts();
            renderOtherTabs();
        }

        window.app.switchDetailTab = function(tabName) {
            document.querySelectorAll('.detail-tab').forEach(t=>t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.modal-body').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+tabName).classList.add('active');
        }

        function renderDetailCharts() {
            if(!currentDetailData) return;
            const ctx = document.getElementById('emotionChart').getContext('2d');
            if(emotionChartInstance) emotionChartInstance.destroy();
            
            // â˜…â˜…â˜… å£“åŠ›åœ–è¡¨ä¿®æ­£ï¼š0-50 æ”¾å¤§æ˜ å°„åˆ° 0-100 â˜…â˜…â˜…
            const labels = currentDetailData.monitors.map(m => new Date(m.createdAt.seconds * 1000).toLocaleTimeString());
            const stressData = currentDetailData.monitors.map(m => Math.min(m.stress * 2, 100)); // æ”¾å¤§2å€ï¼Œæœ€é«˜100

            // æ¼¸å±¤èƒŒæ™¯ (ç´…-é»ƒ-ç¶ )
            const gradient = ctx.createLinearGradient(0, 300, 0, 0);
            gradient.addColorStop(0, 'rgba(0, 255, 157, 0.2)');   // Green (Low)
            gradient.addColorStop(0.5, 'rgba(255, 204, 0, 0.2)'); // Yellow (Mid)
            gradient.addColorStop(1, 'rgba(255, 51, 51, 0.3)');   // Red (High)

            emotionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å£“åŠ›å¼·åº¦ (0-50 scale magnified)',
                        data: stressData,
                        borderColor: '#555',
                        borderWidth: 2,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            min: 0, max: 100, 
                            title: {display:true, text:'å£“åŠ›ç™¾åˆ†æ¯” %'},
                            ticks: { callback: function(val) { return val + '%'; } } // é¡¯ç¤ºç™¾åˆ†æ¯”
                        },
                        x: { grid: {display:false} }
                    },
                    plugins: { tooltip: { callbacks: { label: (c)=> `å£“åŠ›å¼·åº¦: ${c.raw}% (åŸå§‹å€¼: ${c.raw/2})` } } }
                }
            });
        }

        function renderOtherTabs() {
            const d = currentDetailData;
            
            // Tab 2: å­¸ç¿’
            const ex = d.exercise[d.exercise.length - 1];
            document.getElementById('tab-learning').innerHTML = `
                <div class="detail-card"><h4>ğŸ¥ å­¸ç¿’éšæ®µ</h4>
                    <div class="info-row"><span class="info-label">é–±è®€æ™‚é•·</span><b>${d.learning ? d.learning.readingTime+'ç§’' : 'æœªå®Œæˆ'}</b></div>
                </div>
                <div class="detail-card"><h4>ğŸ‹ï¸ ç·´ç¿’éšæ®µ</h4>
                    <div class="info-row"><span class="info-label">æœ€æ–°ç‹€æ…‹</span>${ex ? `<span class="badge badge-active">${ex.passed}</span>` : 'æœªé–‹å§‹'}</div>
                    ${ex ? `<div class="code-block">${escapeHtml(ex.code)}</div><div style="color:#666; margin-top:5px;">AI: ${ex.feedback}</div>` : ''}
                </div>`;

            // Tab 3: æ“¬é¡Œèˆ‡äº’è©•
            let scoreTbl = d.aiReview && d.aiReview.aiScores ? `
                <table style="width:100%; text-align:center; font-size:0.9em; margin-top:5px; border:1px solid #eee;">
                    <tr style="background:#f9f9f9"><th>æ­£ç¢º</th><th>é‚è¼¯</th><th>å¯¦ç”¨</th><th>ä»£ç¢¼</th><th>å¯è®€</th></tr>
                    <tr><td>${d.aiReview.aiScores[0]}</td><td>${d.aiReview.aiScores[1]}</td><td>${d.aiReview.aiScores[2]}</td><td>${d.aiReview.aiScores[3]}</td><td>${d.aiReview.aiScores[4]}</td></tr>
                </table><div style="margin-top:5px; font-size:0.8em; color:#666;">AI: ${d.aiReview.aiComment}</div>` : 'å°šç„¡è©•åˆ†';
            
            let peerHtml = d.peerReviews.length > 0 ? d.peerReviews.map(p => `
                <div style="border-top:1px dashed #eee; padding:10px 0;">
                    <div class="info-row"><span>è©•é–±é¡Œç›®ï¼š<b>${p.targetTitle}</b></span><span>çµ¦åˆ†ï¼š${p.scores.join(', ')}</span></div>
                    <div style="font-size:0.9em; color:#555;">è©•èªï¼š${p.comment}</div>
                </div>`).join('') : '<p>å°šæœªè©•é–±ä»–äºº</p>';

            document.getElementById('tab-posing').innerHTML = `
                <div class="detail-card"><h4>ğŸ“ æˆ‘å‡ºçš„é¡Œç›®</h4>${d.posing ? `é¡Œç›®ï¼š<b>${d.posing.probTitle}</b><br>æ•˜è¿°ï¼š${d.posing.probDesc}<div class="code-block">${escapeHtml(d.posing.probCode)}</div>` : 'æœªå‡ºé¡Œ'}${scoreTbl}</div>
                <div class="detail-card"><h4>ğŸ‘€ æˆ‘å°åŒå­¸çš„äº’è©•</h4>${peerHtml}</div>`;

            // Tab 4: åæ€
            document.getElementById('tab-reflection').innerHTML = `<div class="detail-card"><h4>ğŸ¤” åæ€å¿ƒå¾—</h4><p style="line-height:1.6;">${d.reflection ? d.reflection.reflection : 'å°šæœªå¡«å¯«'}</p></div>`;

            // Tab 5: å°è©±
            document.getElementById('tab-chat').innerHTML = `<div class="detail-card"><h4>ğŸ’¬ å¸«ç”Ÿå°è©±ç´€éŒ„</h4><div class="chat-log-box">${d.chats.map(c=>`<div class="chat-item"><span class="chat-user">S: ${c.userMsg}</span><br><span class="chat-ai">AI: ${c.aiMsg}</span></div>`).join('')}</div></div>`;
        }

        // === é€šç”¨è¡¨å–®è™•ç† (Course & Question) ===
        window.app.openForm = function(type, dataStr) {
            const data = dataStr ? JSON.parse(decodeURIComponent(dataStr)) : {};
            const container = document.getElementById('form-fields');
            document.getElementById('inp-type').value = type;
            document.getElementById('inp-id').value = data.id || "";
            document.getElementById('modal-form').style.display = 'flex';
            document.getElementById('form-title').innerText = type==='course' ? 'ç·¨è¼¯æ•™æ' : 'ç·¨è¼¯å­¸ç”Ÿé¡Œç›®';

            if(type === 'course') {
                container.innerHTML = `
                    <div class="form-group"><label>æ’åº</label><input type="number" id="f-order" class="form-input" value="${data.order||1}"></div>
                    <div class="form-group"><label>ğŸ“… é–‹æ”¾æ—¥æœŸ</label><input type="date" id="f-date" class="form-input" value="${data.releaseDate||''}"></div>
                    <div class="form-group"><label>æ¨™é¡Œ</label><input type="text" id="f-title" class="form-input" value="${data.title||''}"></div>
                    <div class="form-group"><label>YouTube ID</label><input type="text" id="f-vid" class="form-input" value="${data.youtubeId||''}"></div>
                    <div class="form-group"><label>æ‘˜è¦</label><input type="text" id="f-sum" class="form-input" value="${data.summary||''}"></div>
                    <div class="form-group"><label>ä»£ç¢¼</label><textarea id="f-code" class="form-input" style="height:60px;">${data.code||''}</textarea></div>
                    <div class="form-group"><label>ç‹€æ…‹</label><select id="f-active" class="form-input"><option value="true" ${data.isActive?'selected':''}>ä¸Šæ¶</option><option value="false" ${!data.isActive?'selected':''}>è‰ç¨¿</option></select></div>
                `;
            } else if (type === 'question') {
                container.innerHTML = `
                    <div class="form-group"><label>æ‰€å±¬å–®å…ƒ</label><input type="text" id="f-unit" class="form-input" value="${data.unitTitle||''}" placeholder="è«‹è¼¸å…¥å–®å…ƒåç¨±ä»¥æ­¸é¡"></div>
                    <div class="form-group"><label>é¡Œç›®åç¨±</label><input type="text" id="f-qtitle" class="form-input" value="${data.probTitle||''}"></div>
                    <div class="form-group"><label>é¡Œç›®æ•˜è¿°</label><textarea id="f-qdesc" class="form-input" style="height:80px;">${data.probDesc||''}</textarea></div>
                    <div class="form-group"><label>åƒè€ƒè§£ç­”</label><textarea id="f-qcode" class="form-input" style="height:80px;">${data.probCode||''}</textarea></div>
                `;
            }
        }

        window.app.saveForm = async function() {
            const type = document.getElementById('inp-type').value;
            const id = document.getElementById('inp-id').value;
            let payload = {};

            if(type === 'course') {
                payload = {
                    order: Number(document.getElementById('f-order').value),
                    title: document.getElementById('f-title').value,
                    youtubeId: document.getElementById('f-vid').value,
                    summary: document.getElementById('f-sum').value,
                    code: document.getElementById('f-code').value,
                    releaseDate: document.getElementById('f-date').value,
                    isActive: document.getElementById('f-active').value === 'true',
                    updatedAt: new Date()
                };
                if(!id) payload.createdAt = new Date();
                try {
                    if(id) await updateDoc(doc(db,"units",id), payload);
                    else await addDoc(collection(db,"units"), payload);
                    document.getElementById('modal-form').style.display='none';
                } catch(e){ alert(e.message); }
            } else if (type === 'question') {
                payload = {
                    unitTitle: document.getElementById('f-unit').value,
                    probTitle: document.getElementById('f-qtitle').value,
                    probDesc: document.getElementById('f-qdesc').value,
                    probCode: document.getElementById('f-qcode').value,
                    updatedAt: new Date()
                };
                try {
                    await updateDoc(doc(db,"records",id), payload);
                    document.getElementById('modal-form').style.display='none';
                } catch(e){ alert(e.message); }
            }
        }

        window.app.openCourseModal = function() { app.openForm('course', ''); }
        window.app.closeCourseModal = function() { document.getElementById('modal-course-form').style.display='none'; }
        window.app.delDoc = async function(col, id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®?")) await deleteDoc(doc(db, col, id)); }
        window.app.toggleStatus = async function(id, s) { await updateDoc(doc(db,"units",id),{isActive:!s}); }
        window.app.closeDetailModal = function() { document.getElementById('modal-student-detail').style.display='none'; }
        window.app.switchView = function(n) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+n).classList.add('active'); document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); }
        function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    </script>
</body>
</html>
